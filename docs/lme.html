<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Mixed-Effect Models</title>

<script src="site_libs/header-attrs-2.17/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Statistical Modeling Examples in R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lm.html">linear models</a>
    </li>
    <li>
      <a href="lrm.html">logistic regression models</a>
    </li>
    <li>
      <a href="cm.html">count models</a>
    </li>
    <li>
      <a href="lme.html">mixed-effect models</a>
    </li>
  </ul>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Mixed-Effect Models</h1>

</div>


<div id="multilevel-model-two-levels" class="section level3">
<h3>Multilevel model: two levels</h3>
<p>The <code>eggprod</code> data in the faraway package contains data on
egg production. <span class="citation">(Faraway 2016)</span> Six pullets
(young hens) were placed into each of 12 pens. Four blocks were formed
from groups of 3 pens based on location. Three treatments were applied.
The number of eggs produced was recorded. Start by visualizing the
distribution of eggs produced split by blocks and treatment.</p>
<pre class="r"><code>library(faraway)
data(&quot;eggprod&quot;)

library(ggplot2)
# Plotting eggs ~ treat
ggplot(eggprod, aes(x=treat, y=eggs, color = treat)) + # Plotting eggs~treat, color by treat
  geom_jitter(position=position_jitter(0.2)) + # Creating a jitter plot,  staggering groups
  coord_flip() + # Flipping x and y coordinates to mimic Base R plotting
  theme_classic() # Using classic theme</code></pre>
<p><img src="lme_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<pre class="r"><code># Plotting eggs ~ block
ggplot(eggprod, aes(x=block, y=eggs, color = block)) + # Plotting eggs~treat, color by treat
  geom_jitter(position=position_jitter(0.2)) + # Creating a jitter plot,  staggering groups
  coord_flip() + # Flipping x and y coordinates to mimic Base R plotting
  theme_classic() # Using classic theme</code></pre>
<p><img src="lme_files/figure-html/unnamed-chunk-1-2.png" width="672" /></p>
<p>This shows visually that treatment O may have produced fewer eggs
than treatment F or E whose distributions are more similar and closer to
one another. The distributions of eggs produced by each block seem to
overlap and are very similar to one another.</p>
<p>Now, we model the number of eggs produced with <code>treat</code> as
a fixed effect and <code>block</code> as a random effect. <span
class="citation">(Faraway 2006)</span> Does <code>treat</code> appear to
affect the number of eggs, and if so, which treatment seems
superior?</p>
<pre class="r"><code>library(lme4)
m &lt;- lmer(eggs ~ treat + (1|block), data = eggprod)
summary(m)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: eggs ~ treat + (1 | block)
##    Data: eggprod
## 
## REML criterion at convergence: 85.4
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.71233 -0.47453 -0.02845  0.64196  1.42942 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  block    (Intercept) 129.9    11.40   
##  Residual             386.9    19.67   
## Number of obs: 12, groups:  block, 4
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)   349.00      11.37  30.702
## treatF         -6.25      13.91  -0.449
## treatO        -42.50      13.91  -3.056
## 
## Correlation of Fixed Effects:
##        (Intr) treatF
## treatF -0.612       
## treatO -0.612  0.500</code></pre>
<pre class="r"><code>library(performance)
icc(m)</code></pre>
<pre><code>## # Intraclass Correlation Coefficient
## 
##     Adjusted ICC: 0.251
##   Unadjusted ICC: 0.144</code></pre>
<pre class="r"><code>VarCorr(m)</code></pre>
<pre><code>##  Groups   Name        Std.Dev.
##  block    (Intercept) 11.399  
##  Residual             19.670</code></pre>
<p>The likeness of egg production in the same block is .25. The
variation around the intercept is 11.40 across blocks. The intercept
fixed effect is the grand mean of eggs across the entire sample when
treat = “E”. The treatF and treatO fixed effects can be interpreted as
the difference in means (e.g., treatE - treatF). Therefore, treatF
produces 6.25 less mean egg production and treatO produces 42.50 less
mean egg production.</p>
<p>This is further substantiated by looking at the means by treatment.
Observed means of eggs by treat:</p>
<pre class="r"><code>tapply(eggprod$eggs, eggprod$treat, mean)</code></pre>
<pre><code>##      E      F      O 
## 349.00 342.75 306.50</code></pre>
<p>Pairwise comparisons, adjusted p-values and confidence intervals:</p>
<pre class="r"><code>library(emmeans)
emmeans(m, pairwise ~ treat)</code></pre>
<pre><code>## $emmeans
##  treat emmean   SE   df lower.CL upper.CL
##  E        349 11.4 7.99      323      375
##  F        343 11.4 7.99      317      369
##  O        306 11.4 7.99      280      333
## 
## Degrees-of-freedom method: kenward-roger 
## Confidence level used: 0.95 
## 
## $contrasts
##  contrast estimate   SE df t.ratio p.value
##  E - F        6.25 13.9  6   0.449  0.8965
##  E - O       42.50 13.9  6   3.056  0.0508
##  F - O       36.25 13.9  6   2.606  0.0892
## 
## Degrees-of-freedom method: kenward-roger 
## P value adjustment: tukey method for comparing a family of 3 estimates</code></pre>
<pre class="r"><code>emmeans(m, pairwise ~ treat) |&gt; confint()</code></pre>
<pre><code>## $emmeans
##  treat emmean   SE   df lower.CL upper.CL
##  E        349 11.4 7.99      323      375
##  F        343 11.4 7.99      317      369
##  O        306 11.4 7.99      280      333
## 
## Degrees-of-freedom method: kenward-roger 
## Confidence level used: 0.95 
## 
## $contrasts
##  contrast estimate   SE df lower.CL upper.CL
##  E - F        6.25 13.9  6  -36.426     48.9
##  E - O       42.50 13.9  6   -0.176     85.2
##  F - O       36.25 13.9  6   -6.426     78.9
## 
## Degrees-of-freedom method: kenward-roger 
## Confidence level used: 0.95 
## Conf-level adjustment: tukey method for comparing a family of 3 estimates</code></pre>
<p>An effect plot:</p>
<pre class="r"><code>library(ggeffects)
ggpredict(m, terms = ~ treat) |&gt; plot(add.data = TRUE)</code></pre>
<p><img src="lme_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>We can now assess model fit and significance of predictors.</p>
<pre class="r"><code>car::Anova(m)</code></pre>
<pre><code>## Analysis of Deviance Table (Type II Wald chisquare tests)
## 
## Response: eggs
##        Chisq Df Pr(&gt;Chisq)   
## treat 10.887  2   0.004324 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>library(lmerTest)
summary(m)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: eggs ~ treat + (1 | block)
##    Data: eggprod
## 
## REML criterion at convergence: 85.4
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.71233 -0.47453 -0.02845  0.64196  1.42942 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  block    (Intercept) 129.9    11.40   
##  Residual             386.9    19.67   
## Number of obs: 12, groups:  block, 4
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)   349.00      11.37  30.702
## treatF         -6.25      13.91  -0.449
## treatO        -42.50      13.91  -3.056
## 
## Correlation of Fixed Effects:
##        (Intr) treatF
## treatF -0.612       
## treatO -0.612  0.500</code></pre>
<p>Running a <span class="math inline">\(\chi^2\)</span> test on the
model, we see that the model including treat is a better fit (<span
class="math inline">\(\chi^2(2,N = 12) = 10.887, p &lt; .01\)</span>)
than the null model (intercept only). By loading the
<code>lmerTest</code> package, we can see in the summary that
specifically, treatment O is significant less than treatment E.</p>
<pre class="r"><code># normality of residuals; looks good
lattice::qqmath(m)</code></pre>
<p><img src="lme_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<pre class="r"><code># constant variance; one pretty big residual (model predicts about 335 but the observed value is closer to 300)
plot(m)</code></pre>
<p><img src="lme_files/figure-html/unnamed-chunk-7-2.png" width="672" /></p>
<pre class="r"><code># constant variance within treatment levels; TreatF has a lot more variability
plot(m, treat ~ resid(.))</code></pre>
<p><img src="lme_files/figure-html/unnamed-chunk-7-3.png" width="672" /></p>
</div>
<div id="repeated-measures-model" class="section level3">
<h3>Repeated-Measures model</h3>
<p>The book <em>Linear Mixed Models</em> presents a study on rat brains
<span class="citation">(West, Welch, and Galecki 2015)</span>. In this
study, five rats had three regions of their brains measured for
“activation” after two different treatments. Since all rats received
both treatments and had the same three regions measured both times, this
is a <em>repeated-measures</em> analysis. Of interest is how the numeric
dependent variable, activate, changes based on treatment and brain
region.</p>
<p>The data is available in the file “rat_brain.dat”. We can import this
file using the <code>read.table()</code> function. We set
<code>header = TRUE</code> because the first row of the data contains
column headers.</p>
<pre class="r"><code>rats &lt;- read.table(&quot;data/rat_brain.dat&quot;, header = TRUE)</code></pre>
<p>The animal column contains the id for each rat. Below we use the
<code>head()</code> function to view the first six rows of data. Notice
the first rat, R111097, has one measure for each combination of
treatment and region. This is why we refer to this as repeated-measures
data.</p>
<pre class="r"><code>head(rats)</code></pre>
<pre><code>##    animal treatment region activate
## 1 R111097         1      1   366.19
## 2 R111097         1      2   199.31
## 3 R111097         1      3   187.11
## 4 R111097         2      1   371.71
## 5 R111097         2      2   302.02
## 6 R111097         2      3   449.70</code></pre>
</div>
<div id="longitudinal-model" class="section level3">
<h3>Longitudinal model</h3>
<p>The <code>phosphate</code> data in the HSAUR3 package contains plasma
inorganic phosphate levels from 33 subjects (20 controls, 13 obese).
<span class="citation">(Hothorn and Everitt 2022)</span></p>
<pre class="r"><code>library(HSAUR3)
data(&quot;phosphate&quot;)
head(phosphate)</code></pre>
<pre><code>##     group  t0 t0.5  t1 t1.5  t2  t3  t4  t5
## 1 control 4.3  3.3 3.0  2.6 2.2 2.5 3.4 4.4
## 2 control 3.7  2.6 2.6  1.9 2.9 3.2 3.1 3.9
## 3 control 4.0  4.1 3.1  2.3 2.9 3.1 3.9 4.0
## 4 control 3.6  3.0 2.2  2.8 2.9 3.9 3.8 4.0
## 5 control 4.1  3.8 2.1  3.0 3.6 3.4 3.6 3.7
## 6 control 3.8  2.2 2.0  2.6 3.8 3.6 3.0 3.5</code></pre>
<p>Reshaping the data facilitates data visualization. The
<code>pivot_longer()</code> function from the tidyr package makes quick
work of this. <span class="citation">(Wickham and Girlich 2022)</span>
We add a subject <code>id</code> to identify subjects after reshaping
the data into a “long” format.</p>
<pre class="r"><code>library(tidyr)
phosphate$id &lt;- 1:nrow(phosphate)
phosphateL &lt;- pivot_longer(phosphate, cols = t0:t5, 
                           names_to = &quot;time&quot;, 
                           names_prefix = &quot;t&quot;,
                           names_transform = list(time = as.numeric),
                           values_to = &quot;level&quot;)
head(phosphateL, n = 10)</code></pre>
<pre><code>## # A tibble: 10 × 4
##    group      id  time level
##    &lt;fct&gt;   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 control     1   0     4.3
##  2 control     1   0.5   3.3
##  3 control     1   1     3  
##  4 control     1   1.5   2.6
##  5 control     1   2     2.2
##  6 control     1   3     2.5
##  7 control     1   4     3.4
##  8 control     1   5     4.4
##  9 control     2   0     3.7
## 10 control     2   0.5   2.6</code></pre>
<p>There appears to be a great deal of variability between the
subjects.</p>
<pre class="r"><code>library(ggplot2)
ggplot(phosphateL) +
  aes(x = time, y = level, group = id) +
  geom_line() +
  facet_wrap(~group)</code></pre>
<p><img src="lme_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>What might be a sensible linear mixed effect model to quantify trend
in time, effect of obesity, and variation between subjects?</p>
</div>
<div id="references" class="section level3 unnumbered">
<h3 class="unnumbered">References</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-faraway_book" class="csl-entry">
Faraway, Julian. 2006. <em>Extending the Linear Model with
<span>R</span></em>. CRC press. <a
href="https://julianfaraway.github.io/faraway/ELM/">https://julianfaraway.github.io/faraway/ELM/</a>.
</div>
<div id="ref-faraway" class="csl-entry">
———. 2016. <em>Faraway: Functions and Datasets for Books by Julian
Faraway</em>. <a
href="https://CRAN.R-project.org/package=faraway">https://CRAN.R-project.org/package=faraway</a>.
</div>
<div id="ref-hsaur3" class="csl-entry">
Hothorn, Torsten, and Brian S. Everitt. 2022. <em>HSAUR3: A Handbook of
Statistical Analyses Using r (3rd Edition)</em>. <a
href="https://CRAN.R-project.org/package=HSAUR3">https://CRAN.R-project.org/package=HSAUR3</a>.
</div>
<div id="ref-west2015" class="csl-entry">
West, Brady T., Kathleen B. Welch, and Andrzej T. Galecki. 2015.
<em>Linear Mixed Models, 2nd Ed.</em> Boca Raton: <span>CRC</span>
Press.
</div>
<div id="ref-tidyr" class="csl-entry">
Wickham, Hadley, and Maximilian Girlich. 2022. <em>Tidyr: Tidy Messy
Data</em>. <a
href="https://CRAN.R-project.org/package=tidyr">https://CRAN.R-project.org/package=tidyr</a>.
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
