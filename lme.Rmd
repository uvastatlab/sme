---
title: "Mixed-Effect Models"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
bibliography: refs.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

### Multilevel model: two levels

The `eggprod` data in the faraway package contains data on egg production. [@faraway] Six pullets (young hens) were placed into each of 12 pens. Four blocks were formed from groups of 3 pens based on location. Three treatments were applied. The number of eggs produced was recorded. Start by visualizing the distribution of eggs produced split by blocks and treatment. 

```{r}
library(faraway)
data("eggprod")

library(ggplot2)
# Plotting eggs ~ treat
ggplot(eggprod, aes(x=treat, y=eggs, color = treat)) + # Plotting eggs~treat, color by treat
  geom_jitter(position=position_jitter(0.2)) + # Creating a jitter plot,  staggering groups
  coord_flip() + # Flipping x and y coordinates to mimic Base R plotting
  theme_classic() # Using classic theme

# Plotting eggs ~ block
ggplot(eggprod, aes(x=block, y=eggs, color = block)) + # Plotting eggs~treat, color by treat
  geom_jitter(position=position_jitter(0.2)) + # Creating a jitter plot,  staggering groups
  coord_flip() + # Flipping x and y coordinates to mimic Base R plotting
  theme_classic() # Using classic theme
```


This shows visually that treatment O may have produced fewer eggs than treatment F or E whose distributions are more similar and closer to one another. The distributions of eggs produced by each block seem to overlap and are very similar to one another. 

Now, we  model the number of eggs produced with `treat` as a fixed effect and `block` as a random effect. [@faraway_book] Does `treat` appear to affect the number of eggs, and if so, which treatment seems superior?

```{r}
library(lme4)
m <- lmer(eggs ~ treat + (1|block), data = eggprod)
summary(m)

library(performance)
icc(m)

VarCorr(m)
```

The likeness of egg production in the same block is .25. The variation around the intercept is 11.40 across blocks. The intercept fixed effect is the grand mean of eggs across the entire sample when treat = "E". The treatF and treatO fixed effects can be interpreted as the difference in means (e.g., treatE - treatF). Therefore, treatF produces 6.25 less mean egg production and treatO produces 42.50 less mean egg production.

This is further substantiated by looking at the means by treatment. Observed means of eggs by treat:

```{r}
tapply(eggprod$eggs, eggprod$treat, mean)
```

Pairwise comparisons, adjusted p-values and confidence intervals:

```{r}
library(emmeans)
emmeans(m, pairwise ~ treat)
emmeans(m, pairwise ~ treat) |> confint()
```

An effect plot:

```{r}
library(ggeffects)
ggpredict(m, terms = ~ treat) |> plot(add.data = TRUE)
```

We can now assess model fit and significance of predictors.

```{r}
car::Anova(m)

library(lmerTest)
summary(m)
```

Running a $\chi^2$ test on the model, we see that the model including treat is a better fit ($\chi^2(2,N = 12) = 10.887, p < .01$) than the null model (intercept only). By loading the `lmerTest` package, we can see in the summary that specifically, treatment O is significant less than treatment E.

```{r}
# normality of residuals; looks good
lattice::qqmath(m)
# constant variance; one pretty big residual (model predicts about 335 but the observed value is closer to 300)
plot(m)
# constant variance within treatment levels; TreatF has a lot more variability
plot(m, treat ~ resid(.))
```


### Repeated-Measures model

The book _Linear Mixed Models_ presents a study on rat brains [@west2015]. In this study, five rats had three regions of their brains measured for "activation" after two different treatments. Since all rats received both treatments and had the same three regions measured both times, this is a _repeated-measures_ analysis. Of interest is how the numeric dependent variable, activate, changes based on treatment and brain region.

The data is available in the file "rat_brain.dat". We can import this file using the `read.table()` function. We set `header = TRUE` because the first row of the data contains column headers.

```{r}
rats <- read.table("data/rat_brain.dat", header = TRUE)
```

The animal column contains the id for each rat. Below we use the `head()` function to view the first six rows of data. Notice the first rat, R111097, has one measure for each combination of treatment and region. This is why we refer to this as repeated-measures data.

```{r}
head(rats)
```



### Longitudinal model

The `phosphate` data in the HSAUR3 package contains plasma inorganic phosphate levels from 33 subjects (20 controls, 13 obese). [@hsaur3]

```{r}
library(HSAUR3)
data("phosphate")
head(phosphate)
```

Reshaping the data facilitates data visualization. The `pivot_longer()` function from the tidyr package makes quick work of this. [@tidyr] We add a subject `id` to identify subjects after reshaping the data into a "long" format. 

```{r}
library(tidyr)
phosphate$id <- 1:nrow(phosphate)
phosphateL <- pivot_longer(phosphate, cols = t0:t5, 
                           names_to = "time", 
                           names_prefix = "t",
                           names_transform = list(time = as.numeric),
                           values_to = "level")
head(phosphateL, n = 10)
```

There appears to be a great deal of variability between the subjects.

```{r}
library(ggplot2)
ggplot(phosphateL) +
  aes(x = time, y = level, group = id) +
  geom_line() +
  facet_wrap(~group)
```

What might be a sensible linear mixed effect model to quantify trend in time, effect of obesity, and variation between subjects? 


### References
