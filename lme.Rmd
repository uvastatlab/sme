---
title: "Mixed-Effect Models"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
bibliography: refs.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

### multilevel modeling

The `eggprod` data in the faraway package contains data on egg production. [@faraway] Six pullets (young hens) were placed into each of 12 pens. Four blocks were formed from groups of 3 pens based on location. Three treatments were applied. The number of eggs produced was recorded. Start by visualizing the distribution of eggs produced split by blocks and treatment. 

```{r}
library(faraway)
data("eggprod")

library(ggplot2)
# Plotting eggs ~ treat
ggplot(eggprod, aes(x=treat, y=eggs, color = treat)) + # Plotting eggs~treat, color by treat
  geom_violin(trim = FALSE) + # Adding violin to show probability density at different values since sample size is small
  geom_jitter(position=position_jitter(0.2)) + # Creating a jitter plot,  staggering groups
  coord_flip() + # Flipping x and y coordinates to mimic Base R plotting
  theme_classic() # Using classic theme

# Plotting eggs ~ block
ggplot(eggprod, aes(x=block, y=eggs, color = block)) + # Plotting eggs~treat, color by treat
  geom_violin(trim = FALSE) + # Adding violin to show probability density at different values since sample size is small
  geom_jitter(position=position_jitter(0.2)) + # Creating a jitter plot,  staggering groups
  coord_flip() + # Flipping x and y coordinates to mimic Base R plotting
  theme_classic() # Using classic theme
```

This shows visually that treatment O may have produced fewer eggs than treatment F or E whose distributions are more similar and closer to one another. The distributions of eggs produced by each block seem to overlap and are very similar to one another. 

Now, we  model the number of eggs produced with `treat` as a fixed effect and `block` as a random effect. [@faraway_book] Does `treat` appear to affect the number of eggs, and if so, which treatment seems superior?

```{r}
library(lme4)
m <- lmer(eggs ~ treat + (1|block), data = eggprod)
car::Anova(m)
```


### longitudinal modeling

The `phosphate` data in the HSAUR3 package contains plasma inorganic phosphate levels from 33 subjects (20 controls, 13 obese). [@hsaur3]

```{r}
library(HSAUR3)
data("phosphate")
head(phosphate)
```

Reshaping the data facilitates data visualization. The `pivot_longer()` function from the tidyr package makes quick work of this. [@tidyr] We add a subject `id` to identify subjects after reshaping the data into a "long" format. 

```{r}
library(tidyr)
phosphate$id <- 1:nrow(phosphate)
phosphateL <- pivot_longer(phosphate, cols = t0:t5, 
                           names_to = "time", 
                           names_prefix = "t",
                           names_transform = list(time = as.numeric),
                           values_to = "level")
head(phosphateL, n = 10)
```

There appears to be a great deal of variability between the subjects.

```{r}
library(ggplot2)
ggplot(phosphateL) +
  aes(x = time, y = level, group = id) +
  geom_line() +
  facet_wrap(~group)
```

What might be a sensible linear mixed effect model to quantify trend in time, effect of obesity, and variation between subjects? 


### References
